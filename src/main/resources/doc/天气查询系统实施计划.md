# 天气查询系统 - 实施计划

该计划概述了实现天气查询系统的架构和步骤，该系统将自动、每天定时更新特定城市的天气数据。

## 用户审核事项

> [!IMPORTANT]
> **持久层配置**：需要在 `pom.xml` 中重新添加 MySQL 驱动和连接池 (Druid) 依赖，以便持久化存储天气数据。
> **定时策略**：使用 Java 原生的 `ScheduledExecutorService`，而非 Spring 等大型框架，以保持项目的轻量化。

## 预期的项目结构

```text
src/main/
├── java/org/example/
│   ├── entity/
│   │   ├── BaseCity.java           # 城市基类 (包含插槽逻辑)
│   │   ├── WeatherForecast.java    # 天气数据实体类
│   │   └── city/                   # 城市类具体插槽
│   │       └── FuzhouCity.java     # 福州城市配置示例
│   ├── mapper/
│   │   ├── WeatherMapper.java      # 天气查询与更新接口
│   │   └── SchemaMapper.java       # 动态 Schema (DDL) 操作接口
│   ├── service/
│   │   └── WeatherService.java     # 业务逻辑 (定时更新 + 分页查询)
│   ├── utils/
│   │   ├── HttpUtils.java          # 已有，需微调 (HTTP/GZIP 解析)
│   │   ├── MyBatisUtils.java       # MyBatis 会话工厂管理
│   │   └── SchemaSyncUtils.java    # 动态加列核心逻辑
│   └── Main.java                   # 启动入口 (初始化定时器与扫描)
└── resources/
    ├── mapper/
    │   ├── WeatherMapper.xml       # 天气相关 SQL (upsert/page)
    │   └── SchemaMapper.xml        # DDL 相关 SQL (SHOW COLUMNS/ALTER)
    ├── db.properties               # 数据库外部链接配置
    └── mybatis-config.xml          # MyBatis 核心配置文件 (别名/插件/映射)
```

## 架构设计决策 (包含插槽式设计与未来迁移 Spring)

为了满足“插槽式”设计需求并确保未来平滑迁移到 Spring，我们将采用以下设计：
-   **插槽式城市模型 (City Slot Model)**：
    -   定义一个抽象基类 `BaseCity`。
    -   **动态 Schema 同步 (Dynamic Schema Sync)**：系统启动时，通过 MyBatis 执行 `SHOW COLUMNS` 检查并自动执行 `ALTER TABLE` 添加新天气元素列。
    -   **自动扫描机制**：利用反射自动发现 `org.example.entity.city` 包下的城市类。
-   **主动/被动双触发机制 (Active/Passive Trigger)**：
    -   **被动**：定时任务全量更新。
    -   **主动**：实时触发查询并入库。
    -   **统一覆盖逻辑**：共用 `upsert` 方法，确保新老数据自动通过 `(city_id, fx_date)` 唯一索引进行覆盖。
-   **分页查询 (Paginated Query)**：
    -   利用 MyBatis 动态 SQL 实现物理分页（`LIMIT`/`OFFSET`）。
-   **面向接口编程**：所有的 Mapper 定义为接口，方便未来 Spring 接管。

## 数据库表设计 (MySQL)

### 1. `city` (城市信息表)
- `id` (VARCHAR, PK): 和风城市 ID。
- `name` (VARCHAR): 城市名称。
- `created_at` (DATETIME): 创建时间。

### 2. `weather_forecast` (天气预报表)
- `id` (INT, PK, AI): 自增主键。
- `city_id` (VARCHAR, FK): 城市 ID。
- `fx_date` (DATE): 预报日期。
- **[动态列]**：自动根据代码补充列。
- **唯一索引**：`UNIQUE KEY (city_id, fx_date)`。

## 拟议变更清单

1.  **[修改] pom.xml**：添加 `mybatis`, `mysql-connector-j`, `druid`, `fastjson2` 依赖。
2.  **[新建] 相关配置**：`db.properties`, `mybatis-config.xml`。
3.  **[实现] 持久层**：`WeatherForecast` 实体，`WeatherMapper` 接口及 XML。
4.  **[实现] 架构核心**：`BaseCity` 抽象类，`SchemaMapper` (处理动态加列)。
5.  **[实现] 业务层**：`WeatherService` (定时器 + 分页查询 + 统一获取保存逻辑)。
6.  **[实现] 工具类**：`MyBatisUtils`, `SchemaSyncUtils`。
